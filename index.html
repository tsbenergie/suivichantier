}

// PWA Functions
let deferredPrompt;
let isInstalled = false;

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
            const CACHE_NAME = 'chantier-v1';
            const urlsToCache = [
                '/',
                '/index.html'
            ];

            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then((cache) => cache.addAll(urlsToCache))
                );
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request)
                        .then((response) => {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                );
            });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
            .then(() => console.log('Service Worker registered'))
            .catch((error) => console.log('Service Worker registration failed:', error));
    });
}

// PWA Install Banner
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showInstallBanner();
});

function showInstallBanner() {
    const banner = document.getElementById('installBanner');
    if (banner && !isInstalled) {
        banner.classList.add('show');
    }
}

function hideInstallBanner() {
    const banner = document.getElementById('installBanner');
    if (banner) {
        banner.classList.remove('show');
    }
}

// Install button click
document.addEventListener('DOMContentLoaded', () => {
    const installBtn = document.getElementById('installBtn');
    const closeBanner = document.getElementById('closeBanner');
    
    if (installBtn) {
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    isInstalled = true;
                    hideInstallBanner();
                }
                deferredPrompt = null;
            }
        });
    }
    
    if (closeBanner) {
        closeBanner.addEventListener('click', hideInstallBanner);
    }
});

// Check if app is installed
window.addEventListener('appinstalled', () => {
    isInstalled = true;
    hideInstallBanner();
    showNotification('Application install√©e avec succ√®s !', 'success');
});

// Online/Offline Detection
function updateOnlineStatus() {
    const offlineIndicator = document.getElementById('offlineIndicator');
    const onlineIndicator = document.getElementById('onlineIndicator');
    
    if (navigator.onLine) {
        if (offlineIndicator) offlineIndicator.classList.remove('show');
        if (onlineIndicator) {
            onlineIndicator.classList.add('show');
            setTimeout(() => onlineIndicator.classList.remove('show'), 3000);
        }
    } else {
        if (onlineIndicator) onlineIndicator.classList.remove('show');
        if (offlineIndicator) offlineIndicator.classList.add('show');
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Local Storage for offline data
function saveDataLocally(key, data) {
    try {
        const timestamp = new Date().toISOString();
        const dataWithTimestamp = { ...data, savedAt: timestamp };
        localStorage.setItem(key, JSON.stringify(dataWithTimestamp));
        showSaveIndicator();
        return true;
    } catch (error) {
        console.error('Error saving data:', error);
        return false;
    }
}

function loadDataLocally(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (error) {
        console.error('Error loading data:', error);
        return null;
    }
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    if (indicator) {
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
    }
}

function showNotification(message, type = 'info') {
    // Simple notification system
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : '#4a90e2'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 1002;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 4000);
}

// Enhanced save functionality
function enhancedSave(formData, sectionName) {
    const saved = saveDataLocally(`chantier_${sectionName}`, formData);
    if (saved) {
        console.log(`Data saved for ${sectionName}`);
    }
}

function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const chantierType = document.getElementById('chantierType').value;
    
    if (username && password) {
        // Save login info
        saveDataLocally('user_session', { username, chantierType, loginTime: new Date().toISOString() });
        
        // Afficher le type de chantier dans l'en-t√™te
        const typeDisplay = document.getElementById('chantierTypeDisplay');
        const headerTitle = document.getElementById('headerTitle');
        
        switch(chantierType) {
            case 'centrale-sol':
                typeDisplay.textContent = 'üåû Centrale au Sol';
                headerTitle.textContent = 'Suivi de Chantier - Centrale au Sol';
                break;
            case 'ombriere':
                typeDisplay.textContent = 'üöó Ombri√®re';
                headerTitle.textContent = 'Suivi de Chantier - Ombri√®re';
                break;
            case 'toiture':
                typeDisplay.textContent = 'üè† Toiture';
                headerTitle.textContent = 'Suivi de Chantier - Toiture';
                break;
        }
        
        // Adapter les formulaires selon le type
        adaptFormsForChantierType(chantierType);
        
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        
        // Load saved data if available
        loadSavedData();
        
        showNotification('Connexion r√©ussie !', 'success');
    } else {
        alert('Veuillez remplir tous les champs');
    }
}

function loadSavedData() {
    // Load saved form data
    const sections = ['equipements', 'connecteur', 'chemin-cable', 'terre', 'cable-ac', 'cable-dc', 'cables', 'installations'];
    
    sections.forEach(section => {
        const savedData = loadDataLocally(`chantier_${section}`);
        if (savedData) {
            // Populate form fields with saved data
            console.log(`Loaded data for ${section}:`, savedData);
        }
    });
}

function logout() {
    // Clear session data
    localStorage.removeItem('user_session');
    
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('chantierType').value = 'centrale-sol';
    
    showNotification('D√©connexion r√©ussie');
}

// PWA Functions
let deferredPrompt;
let isInstalled = false;

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
            const CACHE_NAME = 'chantier-v1';
            const url<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi de Chantier</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><rect fill="%23f0f0f0" width="1200" height="800"/><rect fill="%23ddd" x="0" y="400" width="1200" height="200"/><rect fill="%23bbb" x="100" y="300" width="200" height="300"/><rect fill="%23999" x="400" y="250" width="150" height="350"/><rect fill="%23777" x="700" y="200" width="100" height="400"/><circle fill="%23ff6b35" cx="1000" cy="150" r="80"/></svg>');
    background-size: cover;
    background-position: center;
}

.login-box {
    background: rgba(255, 255, 255, 0.95);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    width: 400px;
    text-align: center;
    backdrop-filter: blur(10px);
}

.logo {
    width: 120px;
    height: 120px;
    background: #4a90e2;
    border-radius: 20px;
    margin: 0 auto 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 10px 20px rgba(74, 144, 226, 0.3);
}

h1 {
    color: #333;
    margin-bottom: 30px;
    font-size: 28px;
}

.form-group {
    margin-bottom: 20px;
    text-align: left;
}

label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: 500;
}

input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.3s;
}

input:focus {
    outline: none;
    border-color: #4a90e2;
}

.login-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(74, 144, 226, 0.4);
}

.main-app {
    display: none;
    min-height: 100vh;
    background: #f5f7fa;
}

.header {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
}

.header h1 {
    margin: 0;
    color: white;
}

.logout-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}

.nav-tabs {
    background: white;
    padding: 0;
    border-bottom: 3px solid #4a90e2;
    display: flex;
}

.nav-tab {
    padding: 15px 25px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: #666;
    position: relative;
    transition: color 0.3s;
}

.nav-tab.active {
    color: #4a90e2;
}

.nav-tab.active::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    right: 0;
    height: 3px;
    background: #4a90e2;
}

.content {
    padding: 30px;
}

.section {
    display: none;
}

.section.active {
    display: block;
}

.sub-nav {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.sub-nav-tabs {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.sub-nav-tab {
    padding: 12px 20px;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    color: #495057;
}

.sub-nav-tab.active {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: block;
}

.card.sub-section {
    display: none;
}

.card.sub-section.active {
    display: block;
}

#fin .card {
    display: block !important;
}

.card h3 {
    color: #333;
    margin-bottom: 20px;
    font-size: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

th, td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.btn {
    background: #4a90e2;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s;
}

.btn:hover {
    background: #357abd;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4a90e2, #28a745);
    transition: width 0.3s ease;
}

select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 10px;
}

@media (max-width: 768px) {
    .login-box {
        width: 90%;
        padding: 30px 20px;
    }
    
    .content {
        padding: 15px;
    }
    
    .nav-tab {
        padding: 12px 15px;
        font-size: 14px;
    }
}
</style>
</head>
<body>
<!-- Page de Connexion -->
<div id="loginPage" class="login-container">
<div class="login-box">
    <div class="logo">LOGO</div>
    <h1>Suivi de Chantier</h1>
    <div class="form-group">
        <label for="username">Nom d'utilisateur</label>
        <input type="text" id="username" placeholder="Entrez votre nom">
    </div>
    <div class="form-group">
        <label for="password">Mot de passe</label>
        <input type="password" id="password" placeholder="Entrez votre mot de passe">
    </div>
    <div class="form-group">
        <label for="chantierType">Type de chantier</label>
        <select id="chantierType">
            <option value="centrale-sol">Centrale au Sol</option>
            <option value="ombriere">Ombri√®re</option>
            <option value="toiture">Toiture</option>
        </select>
    </div>
    <button class="login-btn" onclick="login()">Se connecter</button>
</div>
</div>

<!-- Application Principale -->
<div id="mainApp" class="main-app">
<div class="header">
    <h1 id="headerTitle">Suivi de Chantier - Syst√®me de Gestion</h1>
    <div style="position: absolute; top: 15px; left: 20px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; color: white; font-weight: 500;">
        <span id="chantierTypeDisplay">Type de chantier</span>
    </div>
    <button class="logout-btn" onclick="logout()">D√©connexion</button>
</div>

<div class="nav-tabs">
    <button class="nav-tab active" onclick="showSection('reception')">R√©ception du Chantier</button>
    <button class="nav-tab" onclick="showSection('avancement')">Avancement du Chantier</button>
    <button class="nav-tab" onclick="showSection('fin')">Fin du Chantier</button>
</div>

<div class="content">
    <!-- Section R√©ception -->
    <div id="reception" class="section active">
        <div class="sub-nav">
            <div class="sub-nav-tabs">
                <div class="sub-nav-tab active" onclick="showSubSection('reception', 'equipements')">√âquipements</div>
                <div class="sub-nav-tab" onclick="showSubSection('reception', 'connecteur')">Connecteur</div>
                <div class="sub-nav-tab" onclick="showSubSection('reception', 'chemin-cable')">Chemin de C√¢ble</div>
                <div class="sub-nav-tab" onclick="showSubSection('reception', 'terre')">Terre</div>
                <div class="sub-nav-tab" onclick="showSubSection('reception', 'cable-ac')">C√¢ble AC</div>
                <div class="sub-nav-tab" onclick="showSubSection('reception', 'cable-dc')">C√¢ble DC</div>
            </div>
        </div>

        <div id="reception-equipements" class="card sub-section active">
            <h3>√âquipements</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de machine</label>
                    <select id="machine-type">
                        <option value="nacelle-ciseau">Nacelle ciseau</option>
                        <option value="nacelle-bras">Nacelle √† bras</option>
                        <option value="manitou">Manitou</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>R√©f√©rence</label>
                    <input type="text" placeholder="Num√©ro de s√©rie">
                </div>
                <div class="form-group">
                    <label>√âtat</label>
                    <select>
                        <option>Bon √©tat</option>
                        <option>√Ä v√©rifier</option>
                        <option>D√©faillant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date de r√©ception</label>
                    <input type="date">
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>

        <div id="reception-connecteur" class="card sub-section">
            <h3>Connecteur</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de connecteur</label>
                    <input type="text" placeholder="Ex: MC4, Anderson">
                </div>
                <div class="form-group">
                    <label>Quantit√© re√ßue</label>
                    <input type="number" placeholder="Nombre d'unit√©s">
                </div>
                <div class="form-group">
                    <label>Conformit√©</label>
                    <select>
                        <option>Conforme</option>
                        <option>Non conforme</option>
                    </select>
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>

        <div id="reception-chemin-cable" class="card sub-section">
            <h3>Chemin de C√¢ble</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de chemin</label>
                    <input type="text" placeholder="Ex: Goulotte, Conduit" id="chemin-type">
                </div>
                <div class="form-group">
                    <label>Longueur (m)</label>
                    <input type="number" step="0.1" placeholder="Longueur en m√®tres">
                </div>
                <div class="form-group">
                    <label>Section (mm)</label>
                    <input type="text" placeholder="Dimensions">
                </div>
                <!-- Champs sp√©cifiques par type -->
                <div class="form-group chantier-specific" id="chemin-centrale-sol" style="display: none;">
                    <label>Profondeur enfouissement (cm)</label>
                    <input type="number" placeholder="Profondeur en cm">
                </div>
                <div class="form-group chantier-specific" id="chemin-ombriere" style="display: none;">
                    <label>Protection UV</label>
                    <select>
                        <option>Oui</option>
                        <option>Non</option>
                    </select>
                </div>
                <div class="form-group chantier-specific" id="chemin-toiture" style="display: none;">
                    <label>√âtanch√©it√©</label>
                    <select>
                        <option>Passe-toit √©tanche</option>
                        <option>Conduit apparent</option>
                        <option>Encastr√©</option>
                    </select>
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>

        <div id="reception-terre" class="card sub-section">
            <h3>Terre</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de prise de terre</label>
                    <input type="text" placeholder="Ex: Piquet, Fond de fouille">
                </div>
                <div class="form-group">
                    <label>R√©sistance mesur√©e (Œ©)</label>
                    <input type="number" step="0.1" placeholder="Valeur en Ohms">
                </div>
                <div class="form-group">
                    <label>Conformit√© NFC 15-100</label>
                    <select>
                        <option>Conforme</option>
                        <option>Non conforme</option>
                    </select>
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>

        <div id="reception-cable-ac" class="card sub-section">
            <h3>C√¢ble AC</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de c√¢ble</label>
                    <input type="text" placeholder="Ex: RO2V 3G6">
                </div>
                <div class="form-group">
                    <label>Longueur re√ßue (m)</label>
                    <input type="number" step="0.1" placeholder="Longueur en m√®tres">
                </div>
                <div class="form-group">
                    <label>Section (mm¬≤)</label>
                    <input type="text" placeholder="Section du c√¢ble">
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>

        <div id="reception-cable-dc" class="card sub-section">
            <h3>C√¢ble DC</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Type de c√¢ble</label>
                    <input type="text" placeholder="Ex: Solar cable 4mm¬≤">
                </div>
                <div class="form-group">
                    <label>Longueur re√ßue (m)</label>
                    <input type="number" step="0.1" placeholder="Longueur en m√®tres">
                </div>
                <div class="form-group">
                    <label>Tension nominale (V)</label>
                    <input type="number" placeholder="Tension en Volts">
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>
    </div>

    <!-- Section Avancement -->
    <div id="avancement" class="section">
        <div class="sub-nav">
            <div class="sub-nav-tabs">
                <div class="sub-nav-tab active" onclick="showSubSection('avancement', 'cables')">C√¢bles Tir√©s</div>
                <div class="sub-nav-tab" onclick="showSubSection('avancement', 'installations')">Installations</div>
            </div>
        </div>

        <div id="avancement-cables" class="card sub-section active">
            <h3>Avancement des C√¢bles</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>C√¢ble DC tir√© (m)</label>
                    <input type="number" step="0.1" id="cable-dc-tire">
                </div>
                <div class="form-group">
                    <label>C√¢ble AC tir√© (m)</label>
                    <input type="number" step="0.1" id="cable-ac-tire">
                </div>
                <div class="form-group">
                    <label>C√¢ble Terre tir√© (m)</label>
                    <input type="number" step="0.1" id="cable-terre-tire">
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>

        <div id="avancement-installations" class="card sub-section">
            <h3>Installations</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre de panneaux pos√©s</label>
                    <input type="number" id="panneaux-poses">
                </div>
                <div class="form-group">
                    <label>Nombre de rails pos√©s</label>
                    <input type="number" id="rails-poses">
                </div>
                <div class="form-group chantier-specific" id="install-centrale-sol" style="display: none;">
                    <label>Nombre d'onduleurs pos√©s</label>
                    <input type="number" id="onduleurs-poses">
                </div>
                <div class="form-group chantier-specific" id="install-ombriere" style="display: none;">
                    <label>Nombre d'onduleurs pos√©s</label>
                    <input type="number" id="onduleurs-poses-ombriere">
                </div>
                <!-- Champs sp√©cifiques installation -->
                <div class="form-group chantier-specific" id="install-centrale-sol-2" style="display: none;">
                    <label>Nombre de pieux install√©s</label>
                    <input type="number" placeholder="Nombre de pieux">
                </div>
                <div class="form-group chantier-specific" id="install-ombriere-2" style="display: none;">
                    <label>Nombre de places de parking</label>
                    <input type="number" placeholder="Places cr√©√©es">
                </div>
                <!-- Champs communs suppl√©mentaires selon type -->
                <div class="form-group chantier-specific" id="install-centrale-sol-3" style="display: none;">
                    <label>Surface couverte (m¬≤)</label>
                    <input type="number" step="0.1" placeholder="Surface en m¬≤">
                </div>
                <div class="form-group chantier-specific" id="install-ombriere-3" style="display: none;">
                    <label>√âclairage install√©</label>
                    <select>
                        <option>Oui</option>
                        <option>Non</option>
                        <option>En cours</option>
                    </select>
                </div>
            </div>
            <button class="btn">Enregistrer</button>
        </div>
    </div>

    <!-- Section Fin -->
    <div id="fin" class="section">
        <div class="card active">
            <h3>Tableau des Tensions Finales</h3>
            <p style="margin-bottom: 20px; color: #666;">Relev√© final des tensions prises sur le chantier</p>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Zone</th>
                            <th>String</th>
                            <th>Tension DC (V)</th>
                            <th>Courant DC (A)</th>
                            <th>Tension AC (V)</th>
                            <th>Puissance (W)</th>
                            <th>Date</th>
                            <th>Technicien</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tensions-finales-tbody">
                        <tr>
                            <td>Zone A</td>
                            <td>String 1</td>
                            <td><input type="number" style="width: 70px; padding: 5px;"></td>
                            <td><input type="number" style="width: 70px; padding: 5px;"></td>
                            <td><input type="number" style="width: 70px; padding: 5px;"></td>
                            <td><input type="number" style="width: 80px; padding: 5px;"></td>
                            <td><input type="date" style="padding: 5px;"></td>
                            <td><input type="text" style="width: 100px; padding: 5px;"></td>
                            <td>
                                <select style="padding: 5px;">
                                    <option>Valid√©</option>
                                    <option>√Ä v√©rifier</option>
                                    <option>Anomalie</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="addTensionFinaleRow()">Ajouter ligne</button>
                <button class="btn">Enregistrer</button>
                <button class="btn" style="background: #28a745;">Exporter PDF</button>
            </div>
        </div>
    </div>
</div>
</div>

<script>
function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const chantierType = document.getElementById('chantierType').value;
    
    if (username && password) {
        // Afficher le type de chantier dans l'en-t√™te
        const typeDisplay = document.getElementById('chantierTypeDisplay');
        const headerTitle = document.getElementById('headerTitle');
        
        switch(chantierType) {
            case 'centrale-sol':
                typeDisplay.textContent = 'üåû Centrale au Sol';
                headerTitle.textContent = 'Suivi de Chantier - Centrale au Sol';
                break;
            case 'ombriere':
                typeDisplay.textContent = 'üöó Ombri√®re';
                headerTitle.textContent = 'Suivi de Chantier - Ombri√®re';
                break;
            case 'toiture':
                typeDisplay.textContent = 'üè† Toiture';
                headerTitle.textContent = 'Suivi de Chantier - Toiture';
                break;
        }
        
        // Adapter les formulaires selon le type
        adaptFormsForChantierType(chantierType);
        
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
    } else {
        alert('Veuillez remplir tous les champs');
    }
}

function adaptFormsForChantierType(type) {
    // Masquer tous les champs sp√©cifiques
    const specificFields = document.querySelectorAll('.chantier-specific');
    specificFields.forEach(field => field.style.display = 'none');
    
    // Afficher les champs correspondant au type s√©lectionn√©
    const typeFields = document.querySelectorAll(`[id*="-${type}"]`);
    typeFields.forEach(field => {
        if (field.classList.contains('chantier-specific')) {
            field.style.display = 'block';
        }
    });
    
    // Adapter les placeholders selon le type
    adaptPlaceholders(type);
}

function adaptPlaceholders(type) {
    const cheminTypeInput = document.getElementById('chemin-type');
    
    if (cheminTypeInput) {
        switch(type) {
            case 'centrale-sol':
                cheminTypeInput.placeholder = 'Ex: Fourreau enterr√©, Caniveau';
                break;
            case 'ombriere':
                cheminTypeInput.placeholder = 'Ex: Goulotte alu, Conduit rigide';
                break;
            case 'toiture':
                cheminTypeInput.placeholder = 'Ex: Gaine ICTA, Conduit apparent';
                break;
        }
    }
}

// Fonction pour adapter les champs selon l'√©quipement s√©lectionn√©
function adaptEquipementFields() {
    const equipementType = document.getElementById('equipement-type').value;
    const hauteurField = document.getElementById('equipement-hauteur');
    const capaciteField = document.getElementById('equipement-capacite');
    const puissanceField = document.getElementById('equipement-puissance');
    
    // Masquer tous les champs sp√©cifiques d'√©quipement
    hauteurField.style.display = 'none';
    capaciteField.style.display = 'none';
    puissanceField.style.display = 'none';
    
    // Afficher les champs selon l'√©quipement
    switch(equipementType) {
        case 'nacelle':
        case 'ciseau':
        case 'bras':
            hauteurField.style.display = 'block';
            capaciteField.style.display = 'block';
            break;
        case 'onduleur':
            puissanceField.style.display = 'block';
            break;
    }
}

// Ajouter l'√©v√©nement au changement de s√©lection d'√©quipement
document.addEventListener('DOMContentLoaded', function() {
    const equipementSelect = document.getElementById('equipement-type');
    if (equipementSelect) {
        equipementSelect.addEventListener('change', adaptEquipementFields);
    }
});

function logout() {
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('chantierType').value = 'centrale-sol';
}

function showSection(sectionName) {
    // Masquer toutes les sections
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => section.classList.remove('active'));
    
    // Masquer tous les onglets actifs
    const navTabs = document.querySelectorAll('.nav-tab');
    navTabs.forEach(tab => tab.classList.remove('active'));
    
    // Afficher la section s√©lectionn√©e
    document.getElementById(sectionName).classList.add('active');
    
    // Activer l'onglet cliqu√©
    event.target.classList.add('active');
}

function showSubSection(section, subSection) {
    // Masquer toutes les cartes sous-sections de la section courante
    const cards = document.querySelectorAll(`#${section} .sub-section`);
    cards.forEach(card => card.classList.remove('active'));
    
    // Masquer tous les sous-onglets actifs de la section courante
    const subTabs = document.querySelectorAll(`#${section} .sub-nav-tab`);
    subTabs.forEach(tab => tab.classList.remove('active'));
    
    // Afficher la carte s√©lectionn√©e
    document.getElementById(`${section}-${subSection}`).classList.add('active');
    
    // Activer le sous-onglet cliqu√©
    event.target.classList.add('active');
}

function addTensionFinaleRow() {
    const tbody = document.getElementById('tensions-finales-tbody');
    const newRow = tbody.insertRow();
    newRow.innerHTML = `
        <td><input type="text" style="width: 70px; padding: 5px;"></td>
        <td><input type="text" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 80px; padding: 5px;"></td>
        <td><input type="date" style="padding: 5px;"></td>
        <td><input type="text" style="width: 100px; padding: 5px;"></td>
        <td>
            <select style="padding: 5px;">
                <option>Valid√©</option>
                <option>√Ä v√©rifier</option>
                <option>Anomalie</option>
            </select>
        </td>
    `;
}

// Enhanced button functionality with auto-save
document.addEventListener('DOMContentLoaded', function() {
    // Auto-save on form changes
    const forms = document.querySelectorAll('input, select, textarea');
    forms.forEach(input => {
        input.addEventListener('change', function() {
            const section = this.closest('.card')?.id || 'general';
            const formData = {};
            
            // Collect form data from current section
            const sectionInputs = this.closest('.card')?.querySelectorAll('input, select, textarea');
            sectionInputs?.forEach(field => {
                if (field.id || field.name) {
                    formData[field.id || field.name] = field.value;
                }
            });
            
            enhancedSave(formData, section);
        });
    });
    
    // Enhanced save buttons
    const saveButtons = document.querySelectorAll('.btn');
    saveButtons.forEach(btn => {
        if (btn.textContent.includes('Enregistrer')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.closest('.card')?.id || 'manual_save';
                const formData = {};
                
                const sectionInputs = this.closest('.card')?.querySelectorAll('input, select, textarea');
                sectionInputs?.forEach(field => {
                    if (field.id || field.name) {
                        formData[field.id || field.name] = field.value;
                    }
                });
                
                enhancedSave(formData, section);
                showNotification('Donn√©es sauvegard√©es !', 'success');
            });
        }
    });
    
    // Check if user was previously logged in
    const savedSession = loadDataLocally('user_session');
    if (savedSession && savedSession.loginTime) {
        const loginTime = new Date(savedSession.loginTime);
        const now = new Date();
        const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
        
        // Auto-login if session is less than 24 hours old
        if (hoursDiff < 24) {
            document.getElementById('username').value = savedSession.username;
            document.getElementById('chantierType').value = savedSession.chantierType;
            showNotification('Session restaur√©e', 'success');
        }
    }
    
    updateOnlineStatus();
});

function addTensionFinaleRow() {
    const tbody = document.getElementById('tensions-finales-tbody');
    const newRow = tbody.insertRow();
    newRow.innerHTML = `
        <td><input type="text" style="width: 70px; padding: 5px;"></td>
        <td><input type="text" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 70px; padding: 5px;"></td>
        <td><input type="number" style="width: 80px; padding: 5px;"></td>
        <td><input type="date" style="padding: 5px;"></td>
        <td><input type="text" style="width: 100px; padding: 5px;"></td>
        <td>
            <select style="padding: 5px;">
                <option>Valid√©</option>
                <option>√Ä v√©rifier</option>
                <option>Anomalie</option>
            </select>
        </td>
    `;
    
    // Add auto-save to new inputs
    newRow.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('change', function() {
            enhancedSave({tableData: 'updated'}, 'tensions_finales');
        });
    });
}

// Permettre la connexion avec Entr√©e
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('password');
    if (passwordField) {
        passwordField.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    }
});
</script>
</body>
</html>